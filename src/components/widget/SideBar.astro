---
import type { MarkdownHeading } from "astro";
import Categories from "./Categories.astro";
import Profile from "./Profile.astro";
import Tag from "./Tags.astro";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
}

const className = Astro.props.class;
---
<div id="sidebar" class:list={[className, "w-full"]}>
    <div class="flex flex-col w-full gap-4 mb-4">
        <Profile></Profile>
        <div class="card-base p-4 rounded-[var(--radius-large)] transition bg-[var(--card-bg)]">
            <h3 class="font-bold text-lg mb-3 text-neutral-900 dark:text-neutral-100 transition relative ml-3
                before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
                before:absolute before:-left-3 before:top-[0.33rem]">
                路线选择
            </h3>
            <div class="space-y-2">
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-[var(--float-panel-bg)] transition cursor-pointer route-item" id="route-hk" data-url="https://rtxvdz.top">
                    <span class="text-white">香港CDN路线</span>
                    <span id="ping-hk" class="ping-indicator">●</span>
                </div>
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-[var(--float-panel-bg)] transition cursor-pointer route-item" id="route-netlify" data-url="https://n.rtxvdz.top">
                    <span class="text-white">Netlify路线</span>
                    <span id="ping-netlify" class="ping-indicator">●</span>
                </div>
            </div>
        </div>
    </div>
    <div id="sidebar-sticky" class="transition-all duration-700 flex flex-col w-full gap-4 top-4 sticky top-4">
        <Categories class="onload-animation" style="animation-delay: 150ms"></Categories>
        <Tag class="onload-animation" style="animation-delay: 200ms"></Tag>
    </div>
</div>

<style>
    .ping-indicator {
        font-size: 1.2rem;
        transition: color 0.3s ease;
    }
    .ping-fast {
        color: #10b981; /* 绿色 - 流畅 */
    }
    .ping-medium {
        color: #f59e0b; /* 黄色 - 中等 */
    }
    .ping-slow {
        color: #ef4444; /* 红色 - 超时/慢 */
    }
    .current-route {
        background: var(--primary) !important;
        color: white !important;
        font-weight: bold;
    }
</style>

<script>
    // 测试网络延迟的函数
    async function testPing(url, timeout = 5000) {
        const start = Date.now();
        
        try {
            // 创建一个唯一的URL以避免缓存
            const testUrl = url + '/?ping=' + Date.now();
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            // 发送 HEAD 请求，对服务器压力更小
            const response = await fetch(testUrl, {
                method: 'HEAD', // 使用 HEAD 请求，只获取响应头
                signal: controller.signal,
                mode: 'cors',
                cache: 'no-cache'
            });
            
            clearTimeout(timeoutId);
            const end = Date.now();
            const ping = end - start;
            
            // 检查响应状态，只要能连接上就算成功
            const success = response.ok || response.status < 500;
            
            return { ping, success };
        } catch (error) {
            clearTimeout(timeoutId);
            const end = Date.now();
            const ping = end - start;
            
            // 如果请求被中止（超时），返回超时信息
            if (error.name === 'AbortError') {
                return { ping: timeout, success: false };
            }
            // 其他错误也返回失败
            return { ping, success: false };
        }
    }

    // 更新延迟指示器
    async function updatePingIndicator(elementId, url) {
        const indicator = document.getElementById(elementId);
        if (!indicator) return;
        
        // 测试延迟
        const result = await testPing(url);
        const ping = result.ping;
        
        // 移除旧的类
        indicator.classList.remove('ping-fast', 'ping-medium', 'ping-slow');
        
        // 根据延迟添加适当的类
        if (result.success) {
            if (ping < 200) {
                indicator.classList.add('ping-fast'); // 绿色 - 流畅
            } else if (ping < 500) {
                indicator.classList.add('ping-medium'); // 黄色 - 中等
            } else {
                indicator.classList.add('ping-slow'); // 红色 - 慢
            }
        } else {
            indicator.classList.add('ping-slow'); // 红色 - 超时
        }
        
        // 在元素上设置延迟信息，便于调试
        indicator.title = `延迟: ${ping}ms`;
    }

    // 打开路由链接
    function openRoute(url) {
        window.location.href = url;
    }

    // 高亮当前域名
    function highlightCurrentRoute() {
        const currentHost = window.location.hostname;
        const routeHk = document.getElementById('route-hk');
        const routeNetlify = document.getElementById('route-netlify');
        
        // 移除之前的高亮
        routeHk?.classList.remove('current-route');
        routeNetlify?.classList.remove('current-route');
        
        // 根据当前域名高亮对应项
        if (currentHost === 'rtxvdz.top' || currentHost === 'www.rtxvdz.top') {
            routeHk?.classList.add('current-route');
        } else if (currentHost === 'n.rtxvdz.top' || currentHost === 'www.n.rtxvdz.top') {
            routeNetlify?.classList.add('current-route');
        }
    }

    // 添加点击事件监听器
    function addClickListeners() {
        const routeHk = document.getElementById('route-hk');
        const routeNetlify = document.getElementById('route-netlify');
        
        if (routeHk) {
            routeHk.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                openRoute(url);
            });
        }
        
        if (routeNetlify) {
            routeNetlify.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                openRoute(url);
            });
        }
    }

    // 页面加载后开始测试延迟
    document.addEventListener('DOMContentLoaded', async () => {
        // 高亮当前域名
        highlightCurrentRoute();
        
        // 添加点击事件监听器
        addClickListeners();
        
        // 测试香港CDN路线延迟
        updatePingIndicator('ping-hk', 'https://rtxvdz.top');
        
        // 测试Netlify路线延迟
        updatePingIndicator('ping-netlify', 'https://n.rtxvdz.top');
        
        // 每30秒更新一次延迟（可根据需要调整）
        setInterval(() => {
            updatePingIndicator('ping-hk', 'https://rtxvdz.top');
            updatePingIndicator('ping-netlify', 'https://n.rtxvdz.top');
        }, 30000);
    });
</script>
